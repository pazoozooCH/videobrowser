@if (preview.active()) {
  <div class="preview-panel">
    <div class="header">
      <span class="title">Video Preview</span>
      <button class="close-btn" (click)="preview.close()">Close</button>
    </div>

    <div class="mode-bar">
      @for (preset of presets; track preset.label) {
        <button
          class="mode-btn"
          [class.active]="isActiveMode(preset.mode)"
          (click)="selectMode(preset.mode)"
        >{{ preset.label }}</button>
      }
    </div>

    @if (preview.folderMode()) {
      <!-- Folder mode -->
      <div class="content">
        @if (preview.error(); as error) {
          <div class="error">{{ error }}</div>
        } @else {
          @if (preview.loading()) {
            <div class="progress">Processing file {{ preview.folderEntries().length }} ...</div>
          }
          @for (entry of preview.folderEntries(); track entry.filePath) {
            <div class="folder-entry">
              <div class="folder-entry-header">{{ entry.relativePath }}</div>
              @if (entry.info; as info) {
                <div class="info-section">
                  <div class="info-row">
                    <span class="info-label">Duration</span>
                    <span class="info-value">{{ formatTimestamp(info.durationSecs) }}</span>
                  </div>
                  <div class="info-row">
                    <span class="info-label">Size</span>
                    <span class="info-value">{{ formatFileSize(info.fileSizeBytes) }}</span>
                  </div>
                  @if (info.width && info.height) {
                    <div class="info-row">
                      <span class="info-label">Resolution</span>
                      <span class="info-value">{{ info.width }}x{{ info.height }}</span>
                    </div>
                  }
                  @if (info.displayAspectRatio) {
                    <div class="info-row">
                      <span class="info-label">Aspect Ratio</span>
                      <span class="info-value">{{ info.displayAspectRatio }}</span>
                    </div>
                  }
                  @if (info.codec) {
                    <div class="info-row">
                      <span class="info-label">Codec</span>
                      <span class="info-value">{{ info.codec }}</span>
                    </div>
                  }
                  @if (info.bitrate) {
                    <div class="info-row">
                      <span class="info-label">Bitrate</span>
                      <span class="info-value">{{ formatBitrate(info.bitrate) }}</span>
                    </div>
                  }
                  @if (info.framerate) {
                    <div class="info-row">
                      <span class="info-label">Framerate</span>
                      <span class="info-value">{{ info.framerate }} fps</span>
                    </div>
                  }
                </div>
              }
              @if (entry.error; as entryError) {
                <div class="error">{{ entryError }}</div>
              }
              <div class="grid">
                @for (frame of entry.frames; track frame.index) {
                  <div class="frame">
                    <img [src]="'data:image/jpeg;base64,' + frame.dataBase64" [alt]="'Frame at ' + formatTimestamp(frame.timestampSecs)" />
                    <span class="timestamp">{{ formatTimestamp(frame.timestampSecs) }}</span>
                  </div>
                }
              </div>
            </div>
          }
        }
      </div>
    } @else {
      <!-- Single file mode -->
      @if (preview.info(); as info) {
        <div class="info-section">
          <div class="info-row">
            <span class="info-label">Duration</span>
            <span class="info-value">{{ formatTimestamp(info.durationSecs) }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Size</span>
            <span class="info-value">{{ formatFileSize(info.fileSizeBytes) }}</span>
          </div>
          @if (info.width && info.height) {
            <div class="info-row">
              <span class="info-label">Resolution</span>
              <span class="info-value">{{ info.width }}x{{ info.height }}</span>
            </div>
          }
          @if (info.displayAspectRatio) {
            <div class="info-row">
              <span class="info-label">Aspect Ratio</span>
              <span class="info-value">{{ info.displayAspectRatio }}</span>
            </div>
          }
          @if (info.codec) {
            <div class="info-row">
              <span class="info-label">Codec</span>
              <span class="info-value">{{ info.codec }}</span>
            </div>
          }
          @if (info.bitrate) {
            <div class="info-row">
              <span class="info-label">Bitrate</span>
              <span class="info-value">{{ formatBitrate(info.bitrate) }}</span>
            </div>
          }
          @if (info.framerate) {
            <div class="info-row">
              <span class="info-label">Framerate</span>
              <span class="info-value">{{ info.framerate }} fps</span>
            </div>
          }
        </div>
      }

      <div class="content">
        @if (preview.error(); as error) {
          <div class="error">{{ error }}</div>
        } @else {
          @if (preview.loading()) {
            <div class="progress">Loading frame {{ preview.frames().length + 1 }} of {{ preview.totalFrames() }}...</div>
          }
          <div class="grid">
            @for (frame of preview.frames(); track frame.index) {
              <div class="frame">
                <img [src]="'data:image/jpeg;base64,' + frame.dataBase64" [alt]="'Frame at ' + formatTimestamp(frame.timestampSecs)" />
                <span class="timestamp">{{ formatTimestamp(frame.timestampSecs) }}</span>
              </div>
            }
          </div>
        }
      </div>
    }
  </div>
}
